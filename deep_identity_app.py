import os
import json
from datetime import datetime
from typing import List, Dict, Any, Optional

import streamlit as st
from openai import OpenAI


RESULTS_FILE = "deep_identity_results.json"


# ---------- –£–¢–ò–õ–ò–¢–´ –•–†–ê–ù–ï–ù–ò–Ø ----------

def load_results() -> List[Dict[str, Any]]:
    if not os.path.exists(RESULTS_FILE):
        return []
    try:
        with open(RESULTS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return []


def save_results(items: List[Dict[str, Any]]) -> None:
    with open(RESULTS_FILE, "w", encoding="utf-8") as f:
        json.dump(items, f, ensure_ascii=False, indent=2)


def get_next_result_id(items: List[Dict[str, Any]]) -> int:
    if not items:
        return 1
    return max(int(i.get("id", 0)) for i in items) + 1


# ---------- OPENAI –ö–õ–ò–ï–ù–¢ ----------

def get_openai_client() -> Optional[OpenAI]:
    """
    1) –ü—Ä–æ–±—É–µ–º st.secrets["OPENAI_API_KEY"]
    2) –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_API_KEY
    3) –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    """
    api_key = None

    try:
        api_key = st.secrets.get("OPENAI_API_KEY", None)  # type: ignore[attr-defined]
    except Exception:
        api_key = None

    if not api_key:
        api_key = os.environ.get("OPENAI_API_KEY")

    if not api_key:
        return None

    return OpenAI(api_key=api_key)


# ---------- –ë–õ–û–ö 1 (–ö–õ–ò–ï–ù–¢) ----------

def run_block1_client():
    st.header("–ë–ª–æ–∫ 1. –î–µ—Ç—Å—Ç–≤–æ, —à–∫–æ–ª–∞, –ø–µ—Ä–≤—ã–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è")

    st.markdown(
        """
        –≠—Ç–æ—Ç –±–ª–æ–∫ ‚Äî –ø—Ä–æ **—Ç–≤–æ–∏ —Ä–∞–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã**, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ —Å–∏–ª—å–Ω–æ
        –ø—Ä–æ—è–≤–ª—è—é—Ç –±–∞–∑–æ–≤—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã.  
        –ü–∏—à–∏ —á–µ—Å—Ç–Ω–æ, –∫–∞–∫ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è. –ó–¥–µ—Å—å –Ω–µ—Ç ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö¬ª –æ—Ç–≤–µ—Ç–æ–≤.

        _–≠—Ç–æ —Å–∞–º—ã–µ —Ü–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ ‚Äî –æ–Ω–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –∫–æ—Ä–Ω–∏ —Ç–≤–æ–∏—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π._
        """
    )

    q1 = st.text_area(
        "1. –ö–∞–∫–∏–µ —à–∫–æ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Ç–µ–±–µ –Ω—Ä–∞–≤–∏–ª–∏—Å—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∏ –ø–æ—á–µ–º—É?",
        value=st.session_state.get("b1_q1", ""),
        key="b1_q1",
        height=120,
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ª—ë–≥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –≥–¥–µ –º–æ–∂–Ω–æ —Ä–∞—Å—Å—É–∂–¥–∞—Ç—å‚Ä¶ –∏–ª–∏ —Ç–æ—á–Ω—ã–µ, –∏–ª–∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ‚Ä¶",
    )

    q2 = st.text_area(
        "2. –ë—ã–ª–∏ –ª–∏ –∫—Ä—É–∂–∫–∏/—Å–µ–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã —Å–∞–º(–∞) –≤—ã–±–∏—Ä–∞–ª(–∞)? –ß—Ç–æ —Ç–µ–±—è –≤ –Ω–∏—Ö –ø—Ä–∏—Ç—è–≥–∏–≤–∞–ª–æ?",
        value=st.session_state.get("b1_q2", ""),
        key="b1_q2",
        height=120,
        placeholder="–í–∞–∂–Ω–æ: –Ω–µ —Ç–æ, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏, –∞ —á—Ç–æ —Ç—ã –≤—ã–±–∏—Ä–∞–ª(–∞) —Å–∞–º(–∞).",
    )

    q3 = st.text_area(
        "3. –í –¥–µ—Ç—Å—Ç–≤–µ —Ç—ã –±–æ–ª—å—à–µ –±—ã–ª(–∞) —Ç–∏—Ö–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–º –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–º –±–æ–ª—Ç—É–Ω–æ–º?",
        value=st.session_state.get("b1_q3", ""),
        key="b1_q3",
        height=120,
        placeholder="–û–ø–∏—à–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –º–∞–Ω–µ—Ä—É –æ–±—â–µ–Ω–∏—è, —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ª—é–¥–µ–π.",
    )

    q4 = st.text_area(
        "4. –ë—ã–ª–∏ –ª–∏ —É —Ç–µ–±—è –ª—é–±–∏–º—ã–µ –∏–≥—Ä—ã, –º–∏—Ä—ã, –∏–Ω—Ç–µ—Ä–µ—Å—ã, –≤ –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –º–æ–≥(–ª–∞) —É—Ö–æ–¥–∏—Ç—å?",
        value=st.session_state.get("b1_q4", ""),
        key="b1_q4",
        height=120,
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç—Ä–æ–∏—Ç—å, —Ä–∏—Å–æ–≤–∞—Ç—å, —á–∏—Ç–∞—Ç—å, –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å, —Ä—É–∫–æ–≤–æ–¥–∏—Ç—å, –ø—Ä–∏—Ä–æ–¥–∞, –º—É–∑—ã–∫–∞‚Ä¶",
    )

    q5 = st.text_area(
        "5. –ë—ã–ª–∏ –ª–∏ —É —Ç–µ–±—è –¥–æ–º–∞—à–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ? –ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Ä—è–¥–æ–º —Å –Ω–∏–º–∏?",
        value=st.session_state.get("b1_q5", ""),
        key="b1_q5",
        height=120,
        placeholder="–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å, —ç–º–ø–∞—Ç–∏—é, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –≥–ª—É–±–∏–Ω—É.",
    )

    q6 = st.text_area(
        "6. –í—Å–ø–æ–º–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏—é –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞, –∫–æ–≥–¥–∞ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è –ø—Ä—è–º ¬´–≤ —Å–≤–æ–µ–π —Å—Ç–∏—Ö–∏–∏¬ª. –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–ª(–∞)?",
        value=st.session_state.get("b1_q6", ""),
        key="b1_q6",
        height=140,
        placeholder="–≠—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî –æ–Ω —á–∞—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–≤–æ–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª.",
    )

    q7 = st.text_area(
        "7. –ê –Ω–∞–æ–±–æ—Ä–æ—Ç: –∫–æ–≥–¥–∞ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è ¬´–Ω–µ —Å–≤–æ–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º¬ª, –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ? –ß—Ç–æ —ç—Ç–æ –±—ã–ª–æ?",
        value=st.session_state.get("b1_q7", ""),
        key="b1_q7",
        height=140,
        placeholder="–ó–¥–µ—Å—å –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã.",
    )

    st.markdown("### üß© –ù–µ—Å–∫–æ–ª—å–∫–æ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤")

    mood = st.selectbox(
        "–ß—Ç–æ —Ç—ã —á–∞—â–µ –∑–∞–º–µ—á–∞–ª(–∞) –ø–µ—Ä–≤—ã–º, –≤—Ö–æ–¥—è –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ?",
        [
            "–ó–∞–ø–∞—Ö–∏ / –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞",
            "–õ—é–¥–µ–π / —ç–º–æ—Ü–∏–∏",
            "–ü–æ—Ä—è–¥–æ–∫ / —Ö–∞–æ—Å / –¥–µ—Ç–∞–ª–∏",
            "–¶–≤–µ—Ç–∞ / –∫—Ä–∞—Å–æ—Ç—É / —Å–≤–µ—Ç",
            "–õ–æ–≥–∏–∫—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ / —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤",
            "–ù–∏—á–µ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞—Ö–æ–¥–∏–ª(–∞)",
        ],
        key="b1_mood",
    )

    speed = st.selectbox(
        "–ö–∞–∫–æ–π —Ç—ã –±—ã–ª(–∞) –≤ –¥–µ—Ç—Å—Ç–≤–µ?",
        [
            "–û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–º(–æ–π), –∞–∫—Ç–∏–≤–Ω—ã–º(–æ–π)",
            "–°–ø–æ–∫–æ–π–Ω—ã–º(–æ–π), —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–º(–æ–π)",
            "–ó–∞–≤–∏—Å–µ–ª–æ –æ—Ç –∫–æ–º–ø–∞–Ω–∏–∏",
            "–í–æ–æ–±—â–µ –Ω–µ –ø–æ–º–Ω—é",
        ],
        key="b1_speed",
    )

    role = st.selectbox(
        "–ö–∞–∫–∞—è —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ä–æ–ª—å –±—ã–ª–∞ —Ç–µ–±–µ –±–ª–∏–∂–µ?",
        [
            "–õ–∏–¥–µ—Ä / –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä",
            "–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü / –ø–æ–¥–¥–µ—Ä–∂–∫–∞",
            "–¢–≤–æ—Ä–µ—Ü / —Ñ–∞–Ω—Ç–∞–∑—ë—Ä",
            "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ç–æ—Ä / –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å",
            "–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å / –∞–Ω–∞–ª–∏—Ç–∏–∫",
            "–ö–ª–æ—É–Ω / –¥—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏",
            "–ù–∏–∫—Ç–æ ‚Äî —è –±—ã–ª(–∞) —Å–∞–º –ø–æ —Å–µ–±–µ",
        ],
        key="b1_role",
    )

    if st.button("‚úîÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ë–ª–æ–∫ 1"):
        all_parts = []

        for q in [q1, q2, q3, q4, q5, q6, q7]:
            if q.strip():
                all_parts.append(q.strip())

        all_parts.append(
            f"\n[–ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ] –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–≤—ã–º –∑–∞–º–µ—á–∞–µ—Ç: **{mood}**"
        )
        all_parts.append(
            f"[–¢–µ–º–ø –¥–µ—Ç—Å—Ç–≤–∞] –ö–ª–∏–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–µ–±—è –∫–∞–∫: **{speed}**"
        )
        all_parts.append(
            f"[–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ä–æ–ª—å] –ë–ª–∏–∂–µ –≤—Å–µ–≥–æ –±—ã–ª–∞ —Ä–æ–ª—å: **{role}**"
        )

        st.session_state.block1_text = "\n\n".join(all_parts)
        st.session_state.block1_done = True

        st.success("–ë–ª–æ–∫ 1 —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –ë–ª–æ–∫—É 2 üíõ")


# ---------- –ë–õ–û–ö 2 (–ö–õ–ò–ï–ù–¢) ----------

def run_block2_client():
    st.header("–ë–ª–æ–∫ 2. –†–∞–±–æ—Ç–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, —Å–µ–π—á–∞—Å")

    st.markdown(
        """
        –ó–¥–µ—Å—å –º—ã —Å–º–æ—Ç—Ä–∏–º, **–∫–∞–∫ —Ç—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å—Å—è —Å–µ–π—á–∞—Å** ‚Äî –≤ —Ä–∞–±–æ—Ç–µ, –∑–∞–¥–∞—á–∞—Ö, –±—ã—Ç—É.  
        –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –∞ –∫–∞–∫–∏–µ ¬´—Å–∫—Ä—É—á–µ–Ω—ã¬ª –∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
        """
    )

    q1 = st.text_area(
        "1. –ß–µ–º —Ç—ã —Å–µ–π—á–∞—Å –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è (—Ä–∞–±–æ—Ç–∞/–ø—Ä–æ–µ–∫—Ç—ã)? –ß—Ç–æ —Ç–∞–º —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?",
        value=st.session_state.get("b2_q1", ""),
        key="b2_q1",
        height=140,
    )

    q2 = st.text_area(
        "2. –ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–∞—é—Ç —Ç–µ–±–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–∏–¥—É–º–∞—Ç—å, –ø–æ—Å—á–∏—Ç–∞—Ç—å, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –æ–±—â–∞—Ç—å—Å—è, –ø—Ä–æ–¥–∞–≤–∞—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫—Ä–∞—Å–æ—Ç—É‚Ä¶) ",
        value=st.session_state.get("b2_q2", ""),
        key="b2_q2",
        height=140,
    )

    q3 = st.text_area(
        "3. –ß—Ç–æ –Ω–∞ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –≤ –¥–µ–ª–∞—Ö –∑–∞–±–∏—Ä–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Å–∏–ª –∏ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –∫–∞–∫ ¬´–Ω–µ –º–æ—ë¬ª?",
        value=st.session_state.get("b2_q3", ""),
        key="b2_q3",
        height=140,
    )

    q4 = st.text_area(
        "4. –ü—Ä–µ–¥—Å—Ç–∞–≤—å –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –≤ —Ä–∞–±–æ—Ç–µ / —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏. –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å —Å —É—Ç—Ä–∞ –¥–æ –≤–µ—á–µ—Ä–∞?",
        value=st.session_state.get("b2_q4", ""),
        key="b2_q4",
        height=160,
    )

    q5 = st.text_area(
        "5. –ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å–µ–π—á–∞—Å? –ù–∞ —á—Ç–æ –æ–ø–∏—Ä–∞–µ—à—å—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?",
        value=st.session_state.get("b2_q5", ""),
        key="b2_q5",
        height=140,
        placeholder="–õ–æ–≥–∏–∫–∞, —á—É–≤—Å—Ç–≤–∞, —Ç–µ–ª–æ, –∑–Ω–∞–∫–∏, –≤—ã–≥–æ–¥–∞, –º–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö, –∏–Ω—Ç—É–∏—Ü–∏—è‚Ä¶"
    )

    q6 = st.text_area(
        "6. –ï—Å–ª–∏ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Ä–µ–∑–∫–æ —Å–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –±–µ–∑ —Ä–∏—Å–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ ‚Äî –∫—É–¥–∞ –±—ã –ø–æ—Ç—è–Ω—É–ª–æ?",
        value=st.session_state.get("b2_q6", ""),
        key="b2_q6",
        height=140,
    )

    st.markdown("### ‚öôÔ∏è –ü–∞—Ä–∞ –±—ã—Å—Ç—Ä—ã—Ö —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤")

    like_sales = st.selectbox(
        "–ö–∞–∫ —Ç—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –ø—Ä–æ–¥–∞–∂–∞–º / —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏?",
        [
            "–õ—é–±–ª—é, —ç—Ç–æ –∏–≥—Ä–∞ –∏ —ç–Ω–µ—Ä–≥–∏—è",
            "–ú–æ–≥—É, –Ω–æ —É—Å—Ç–∞—é",
            "–ù–µ–Ω–∞–≤–∏–∂—É, –∏–∑–±–µ–≥–∞—é",
            "–ü—Ä–æ–¥–∞–∂–∏ ‚Äî –Ω–æ—Ä–º, –µ—Å–ª–∏ –≤–µ—Ä—é –≤ –ø—Ä–æ–¥—É–∫—Ç",
        ],
        key="b2_sales",
    )

    order_level = st.selectbox(
        "–ö–∞–∫–æ–π —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —É—Ä–æ–≤–µ–Ω—å –ø–æ—Ä—è–¥–∫–∞ –≤ –∑–∞–¥–∞—á–∞—Ö –∏ –∂–∏–∑–Ω–∏?",
        [
            "–û—á–µ–Ω—å —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, –≤—Å—ë –≤ —Å–∏—Å—Ç–µ–º–µ",
            "–ï—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞, –Ω–æ —è –µ—ë –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ª–æ–º–∞—é",
            "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π —Ö–∞–æ—Å, –Ω–æ —è –≤ –Ω—ë–º –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—é—Å—å",
            "–ü–æ–ª–Ω—ã–π —Ö–∞–æ—Å, –∏ –º–Ω–µ –æ—Ç —ç—Ç–æ–≥–æ —Ç—è–∂–µ–ª–æ",
        ],
        key="b2_order",
    )

    body_energy = st.selectbox(
        "–ö–∞–∫ —Ç—ã –æ—â—É—â–∞–µ—à—å —Å–≤–æ—ë —Ç–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—é –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç–∏?",
        [
            "–ú–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏, –ª—é–±–ª—é –¥–≤–∏–∂–µ–Ω–∏–µ",
            "–°—Ä–µ–¥–Ω–µ, —Ö–≤–∞—Ç–∞—é –Ω–∞ –≤–∞–∂–Ω–æ–µ",
            "–ß–∞—Å—Ç–æ —É—Å—Ç–∞–ª–æ—Å—Ç—å, —Ç–µ–ª–æ –∫–∞–∫ –±—É–¥—Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç",
            "–ù–µ —á—É–≤—Å—Ç–≤—É—é —Ç–µ–ª–æ, –∂–∏–≤—É –≤ –≥–æ–ª–æ–≤–µ",
        ],
        key="b2_body",
    )

    if st.button("‚úîÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ë–ª–æ–∫ 2"):
        parts = []
        for q in [q1, q2, q3, q4, q5, q6]:
            if q.strip():
                parts.append(q.strip())

        parts.append(f"\n[–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –ø—Ä–æ–¥–∞–∂–∞–º] {like_sales}")
        parts.append(f"[–£—Ä–æ–≤–µ–Ω—å –ø–æ—Ä—è–¥–∫–∞] {order_level}")
        parts.append(f"[–¢–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è] {body_energy}")

        st.session_state.block2_text = "\n\n".join(parts)
        st.session_state.block2_done = True

        st.success("–ë–ª–æ–∫ 2 —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –û—Å—Ç–∞–ª—Å—è –ë–ª–æ–∫ 3 ‚Äî –ø—Ä–æ –ª—é–¥–µ–π –∏ –º–∏—Ä—ã ‚ú®")


# ---------- –ë–õ–û–ö 3 (–ö–õ–ò–ï–ù–¢) ----------

def run_block3_client():
    st.header("–ë–ª–æ–∫ 3. –õ—é–¥–∏, –≥–µ—Ä–æ–∏, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–∏—Ä—ã")

    st.markdown(
        """
        –í —ç—Ç–æ–º –±–ª–æ–∫–µ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ç–æ, **–∫–∞–∫–∏–µ –ª—é–¥–∏ –∏ –º–∏—Ä—ã —Ç–µ–±—è —Ü–µ–ø–ª—è—é—Ç**.  
        –ß–µ—Ä–µ–∑ —ç—Ç–æ —á–∞—Å—Ç–æ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–µ –∏–ª–∏ –Ω–µ–¥–æ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã.
        """
    )

    q1 = st.text_area(
        "1. –ö–∞–∫–∏–µ —Ç–∏–ø—ã –ª—é–¥–µ–π —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–æ—Å—Ö–∏—â–∞—é—Ç? (–ø–æ –º—ã—à–ª–µ–Ω–∏—é, —Å—Ç–∏–ª—é –∂–∏–∑–Ω–∏, —ç–Ω–µ—Ä–≥–∏–∏)",
        value=st.session_state.get("b3_q1", ""),
        key="b3_q1",
        height=140,
    )

    q2 = st.text_area(
        "2. –ï—Å—Ç—å –ª–∏ —É —Ç–µ–±—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–±—Ä–∞–∑ ¬´–∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Å–µ–±—è¬ª? –û–ø–∏—à–∏ –µ–≥–æ ‚Äî –∫–∞–∫ –æ–Ω –∂–∏–≤—ë—Ç, —á—Ç–æ –¥–µ–ª–∞–µ—Ç, –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç.",
        value=st.session_state.get("b3_q2", ""),
        key="b3_q2",
        height=160,
    )

    q3 = st.text_area(
        "3. –ö–∞–∫–∏–µ —Ñ–∏–ª—å–º—ã, –∫–Ω–∏–≥–∏, –≤—Å–µ–ª–µ–Ω–Ω—ã–µ, –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –ø—Ä–æ –∫–∞–∫–∏—Ö –≥–µ—Ä–æ–µ–≤ ‚Äî —Ç—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å/–ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å —Å–Ω–æ–≤–∞ –∏ —Å–Ω–æ–≤–∞?",
        value=st.session_state.get("b3_q3", ""),
        key="b3_q3",
        height=160,
    )

    q4 = st.text_area(
        "4. –í –∫–∞–∫–∏—Ö —Ä–æ–ª—è—Ö —Ç–µ–±–µ –ª–µ–≥–∫–æ –±—ã—Ç—å —Å—Ä–µ–¥–∏ –ª—é–¥–µ–π? (–¥—Ä—É–≥, –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç–µ–ª—å, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä, —Å–ª—É—à–∞—Ç–µ–ª—å, —à—É—Ç–Ω–∏–∫, –æ–¥–∏–Ω–æ—á–∫–∞ –∏ —Ç.–¥.)",
        value=st.session_state.get("b3_q4", ""),
        key="b3_q4",
        height=160,
    )

    q5 = st.text_area(
        "5. –ö–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ–±—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ—Å—Ö–∏—â–∞—é—Ç –∏ –Ω–µ–º–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä—è—Ç / –∑–∞–≤–∏–¥–Ω–æ?",
        value=st.session_state.get("b3_q5", ""),
        key="b3_q5",
        height=140,
    )

    st.markdown("### üåå –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø—Ä–æ –º–∏—Ä—ã")

    world = st.selectbox(
        "–ï—Å–ª–∏ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞ –≤—Ä–µ–º—è ¬´–∑–∞—Å—Ç—Ä—è—Ç—å¬ª –≤ –æ–¥–Ω–æ–º –º–∏—Ä–µ/—Å–µ—Ç—Ç–∏–Ω–≥–µ, —á—Ç–æ –±—ã —Ç—ã –≤—ã–±—Ä–∞–ª(–∞)?",
        [
            "–ú–∏—Ä, –≥–¥–µ –º–Ω–æ–≥–æ —Å—Ü–µ–Ω—ã, –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π, –∞—Ä—Ç–∏—Å—Ç–æ–≤",
            "–ú–∏—Ä —Ç–∏—à–∏–Ω—ã, –±–∏–±–ª–∏–æ—Ç–µ–∫, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π, –º—É–¥—Ä–æ—Å—Ç–∏",
            "–ú–∏—Ä –±–∏–∑–Ω–µ—Å–∞, —Å–¥–µ–ª–æ–∫, –±–æ–ª—å—à–∏—Ö –¥–µ–Ω–µ–≥ –∏ —Ä–µ—à–µ–Ω–∏–π",
            "–ú–∏—Ä –∫—Ä–∞—Å–æ—Ç—ã, –∏—Å–∫—É—Å—Å—Ç–≤–∞, –¥–∏–∑–∞–π–Ω–∞, —ç—Å—Ç–µ—Ç–∏–∫–∏",
            "–ú–∏—Ä –ø—Ä–∏—Ä–æ–¥—ã, —Ç–µ–ª–µ—Å–Ω–æ—Å—Ç–∏, —Å–ø–æ—Ä—Ç–∞, –¥–≤–∏–∂–µ–Ω–∏—è",
            "–ú–∏—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤, —Å–∏—Å—Ç–µ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä",
            "–ß—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ (—è –æ–ø–∏—à—É —Å–ª–æ–≤–∞–º–∏ –≤—ã—à–µ)",
        ],
        key="b3_world",
    )

    if st.button("‚úîÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ë–ª–æ–∫ 3"):
        parts = []
        for q in [q1, q2, q3, q4, q5]:
            if q.strip():
                parts.append(q.strip())

        parts.append(f"\n[–ú–∏—Ä –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è] {world}")

        st.session_state.block3_text = "\n\n".join(parts)
        st.session_state.block3_done = True

        st.success("–ë–ª–æ–∫ 3 —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∏–Ω–∞–ª—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –º–∞—Å—Ç–µ—Ä—É üåü")


# ---------- –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –ü–û–¢–û–ö: –§–ò–ù–ê–õ ----------

def run_client_flow():
    st.sidebar.markdown("### –†–µ–∂–∏–º: –ö–ª–∏–µ–Ω—Ç")
    st.sidebar.markdown("–¢—ã –ø—Ä–æ—Ö–æ–¥–∏—à—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É Deep Identity.")

    if "block1_done" not in st.session_state:
        st.session_state.block1_done = False
    if "block2_done" not in st.session_state:
        st.session_state.block2_done = False
    if "block3_done" not in st.session_state:
        st.session_state.block3_done = False

    page = st.sidebar.radio(
        "–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –±–ª–æ–∫–∞–º",
        ["–ë–ª–æ–∫ 1", "–ë–ª–æ–∫ 2", "–ë–ª–æ–∫ 3", "–§–∏–Ω–∞–ª"],
    )

    st.title("Deep Identity ¬∑ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤")

    st.markdown(
        """
        –≠—Ç–æ—Ç –æ–ø—Ä–æ—Å ‚Äî **–Ω–µ —Ç–µ—Å—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å**, –∞ –∂–∏–≤–∞—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å–µ—Å—Å–∏—è.  
        –û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ, –∫–∞–∫ –µ—Å—Ç—å —Å–µ–π—á–∞—Å –∏ –∫–∞–∫ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è.
        """
    )

    if page == "–ë–ª–æ–∫ 1":
        run_block1_client()
    elif page == "–ë–ª–æ–∫ 2":
        run_block2_client()
    elif page == "–ë–ª–æ–∫ 3":
        run_block3_client()
    elif page == "–§–∏–Ω–∞–ª":
        st.header("–§–∏–Ω–∞–ª. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –º–∞—Å—Ç–µ—Ä—É")

        st.markdown(
            """
            –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ê—Å–µ–ª–µ.  
            –û–Ω–∞ —Å–æ–±–µ—Ä—ë—Ç –∏–∑ —ç—Ç–æ–≥–æ **–≥–ª—É–±–æ–∫–∏–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä** –∏ –≤–µ—Ä–Ω—ë—Ç—Å—è –∫ —Ç–µ–±–µ —Å –æ—Ç—á—ë—Ç–æ–º.
            """
        )

        client_name = st.text_input("–¢–≤–æ—ë –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è", key="final_name")
        client_contact = st.text_input(
            "–ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏ (email, Telegram –∏–ª–∏ Instagram @username)",
            key="final_contact",
        )
        extra_note = st.text_area(
            "–ï—Å—Ç—å –ª–∏ —É —Ç–µ–±—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å / –≤–æ–ø—Ä–æ—Å –∫ —Ä–∞–∑–±–æ—Ä—É? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)",
            key="final_note",
            height=120,
        )

        b1 = st.session_state.get("block1_text", "").strip()
        b2 = st.session_state.get("block2_text", "").strip()
        b3 = st.session_state.get("block3_text", "").strip()

        if not (b1 and b2 and b3):
            st.warning("–ü–æ—Ö–æ–∂–µ, –∫–∞–∫–æ–π-—Ç–æ –∏–∑ –±–ª–æ–∫–æ–≤ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ü—Ä–æ–π–¥–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –≤ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ.")
        else:
            st.success("–í—Å–µ —Ç—Ä–∏ –±–ª–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –º–∞—Å—Ç–µ—Ä—É.")

            if st.button("üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ê—Å–µ–ª–µ –º–æ–∏ –æ—Ç–≤–µ—Ç—ã"):
                results = load_results()

                new_item = {
                    "id": get_next_result_id(results),
                    "created_at": datetime.utcnow().isoformat(timespec="seconds"),
                    "client_name": client_name.strip() or "–ë–µ–∑ –∏–º–µ–Ω–∏",
                    "client_contact": client_contact.strip(),
                    "extra_note": extra_note.strip(),
                    "block1_text": b1,
                    "block2_text": b2,
                    "block3_text": b3,
                }
                results.append(new_item)
                save_results(results)

                st.success(
                    "–û—Ç–≤–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ê—Å–µ–ª—è —É–≤–∏–¥–∏—Ç –∏—Ö –≤ —Å–≤–æ–µ–π –º–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª–∏ "
                    "–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç —Ä–∞–∑–±–æ—Ä –≤—Ä—É—á–Ω—É—é (—Å –ø–æ–º–æ—â—å—é –ò–ò –∏ —Å–≤–æ–µ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã)."
                )


# ---------- –ú–ê–°–¢–ï–†-–ü–ê–ù–ï–õ–¨ ----------

MASTER_SYSTEM_PROMPT = """
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ê—Å–µ–ª–µ –ñ–∞–Ω—ã–±–µ–∫ –∫–∞–∫ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ò–ò-–∫–æ-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
–≤ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ Deep Identity / –°–ü–ß.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ —Ç–µ–∫—Å—Ç–∞–º –∫–ª–∏–µ–Ω—Ç–∞ (3 –±–ª–æ–∫–∞) —Å–æ–±—Ä–∞—Ç—å:
- –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º (–ê–ú–ï–¢–ò–°–¢, –ì–†–ê–ù–ê–¢, –¶–ò–¢–†–ò–ù,
  –°–ê–ü–§–ò–†, –ì–ï–õ–ò–û–î–û–†, –ò–ó–£–ú–†–£–î, –Ø–ù–¢–ê–†, –†–£–ë–ò–ù, –®–£–ù–ì–ò–¢),
- –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º (1: –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∏–Ω—Ç—É–∏—Ü–∏—è, 2: –ø—Ä–æ—Ü–µ—Å—Å/—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ,
  3: –¥–µ–π—Å—Ç–≤–∏–µ/—Ä–µ–∑—É–ª—å—Ç–∞—Ç),
- –Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ **—á–µ—Ä–Ω–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞**, –∞ –Ω–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

–í–∞–∂–Ω–æ:
- –ù–ï –¥–∞–≤–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, –∞ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–∞–∫ ¬´–ø–æ—Ö–æ–∂–µ¬ª, ¬´–µ—Å—Ç—å –æ—â—É—â–µ–Ω–∏–µ¬ª, ¬´–≤–µ—Ä–æ—è—Ç–Ω–æ¬ª.
- –ü–æ–∫–∞–∑—ã–≤–∞–π, –Ω–∞ –∫–∞–∫–∏–µ —Ñ—Ä–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ —Ç—ã –æ–ø–∏—Ä–∞–µ—à—å—Å—è.
- –î–∞–π –ê—Å–µ–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ—á—Ç–µ–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è.
- –û—Ç–¥–µ–ª—å–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–º–µ—â–µ–Ω–∏—è –ø–æ 1/2/3 —Å—Ç–æ–ª–±—Ü—É (–º–∏–Ω—É—Å/–ø–ª—é—Å) –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é.
"""


def run_master_panel():
    st.sidebar.markdown("### –†–µ–∂–∏–º: –ú–∞—Å—Ç–µ—Ä")
    st.sidebar.markdown("–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ —Ç—ã –≤–∏–¥–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –æ—Ç—á—ë—Ç—ã.")

    st.title("Deep Identity ¬∑ –ú–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å –ê—Å–µ–ª–∏")

    # –º–∞—Å—Ç–µ—Ä-–∫–æ–¥: –ª–∏–±–æ –∏–∑ secrets, –ª–∏–±–æ –¥–µ—Ñ–æ–ª—Ç
    master_code_secret = None
    try:
        master_code_secret = st.secrets.get("MASTER_CODE", None)  # type: ignore[attr-defined]
    except Exception:
        master_code_secret = None

    expected_code = master_code_secret or "ASELYA_MASTER"

    code = st.text_input("–í–≤–µ–¥–∏ –º–∞—Å—Ç–µ—Ä-–∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞", type="password")
    if code != expected_code:
        st.warning("–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—Å—Ç–µ—Ä-–∫–æ–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤.")
        return

    results = load_results()
    if not results:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ deep_identity_results.json.")
        return

    results_sorted = sorted(results, key=lambda x: x.get("created_at", ""), reverse=True)

    st.markdown("### –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤")

    table_rows = []
    for r in results_sorted:
        table_rows.append(
            {
                "ID": r.get("id"),
                "–î–∞—Ç–∞": r.get("created_at"),
                "–ò–º—è": r.get("client_name"),
                "–ö–æ–Ω—Ç–∞–∫—Ç": r.get("client_contact"),
            }
        )
    st.dataframe(table_rows, hide_index=True, use_container_width=True)

    ids = [r.get("id") for r in results_sorted]
    selected_id = st.selectbox("–í—ã–±–µ—Ä–∏ ID –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –æ—Ç—á—ë—Ç–∞", ids)

    current = None
    for r in results_sorted:
        if r.get("id") == selected_id:
            current = r
            break

    if not current:
        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º ID.")
        return

    st.markdown("---")
    st.subheader(f"–ö–ª–∏–µ–Ω—Ç #{current.get('id')} ¬∑ {current.get('client_name')}")

    st.markdown(f"**–ö–æ–Ω—Ç–∞–∫—Ç:** {current.get('client_contact')}")
    if current.get("extra_note"):
        st.markdown("**–ó–∞–ø—Ä–æ—Å / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞:**")
        st.write(current.get("extra_note"))

    with st.expander("–ë–ª–æ–∫ 1 ‚Äî –î–µ—Ç—Å—Ç–≤–æ, —à–∫–æ–ª–∞, —Ä–∞–Ω–Ω–∏–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è"):
        st.markdown(current.get("block1_text", ""))

    with st.expander("–ë–ª–æ–∫ 2 ‚Äî –†–∞–±–æ—Ç–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, —Å–µ–π—á–∞—Å"):
        st.markdown(current.get("block2_text", ""))

    with st.expander("–ë–ª–æ–∫ 3 ‚Äî –õ—é–¥–∏, –≥–µ—Ä–æ–∏, –º–∏—Ä—ã"):
        st.markdown(current.get("block3_text", ""))

    st.markdown("### üßæ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞")

    client = get_openai_client()
    if client is None:
        st.error(
            "OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. "
            "–î–æ–±–∞–≤—å OPENAI_API_KEY –≤ Secrets Streamlit –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è."
        )
        return

    if st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç"):
        with st.spinner("–°–æ–±–∏—Ä–∞—é –≥–∏–ø–æ—Ç–µ–∑—ã –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º‚Ä¶"):
            user_prompt = f"""
–í–æ—Ç –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ç—Ä—ë—Ö –±–ª–æ–∫–∞—Ö.

[–ë–õ–û–ö 1 ‚Äî –î–ï–¢–°–¢–í–û]
{current.get("block1_text", "")}

[–ë–õ–û–ö 2 ‚Äî –†–ê–ë–û–¢–ê –ò –ü–†–û–¶–ï–°–°–´ –°–ï–ô–ß–ê–°]
{current.get("block2_text", "")}

[–ë–õ–û–ö 3 ‚Äî –õ–Æ–î–ò, –ì–ï–†–û–ò, –ú–ò–†–´]
{current.get("block3_text", "")}

–°–¥–µ–ª–∞–π –¥–ª—è –ê—Å–µ–ª–∏ —á–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

1. –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø–æ –æ—â—É—â–µ–Ω–∏—é —á–µ–ª–æ–≤–µ–∫–∞ (1‚Äì2 –∞–±–∑–∞—Ü–∞).
2. –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã (—Ç–æ–ø-3‚Äì5) —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º ¬´–ø–æ—á–µ–º—É —Ç–∞–∫ –¥—É–º–∞–µ–º¬ª –∏ —Ü–∏—Ç–∞—Ç–∞–º–∏/–ø–µ—Ä–µ—Å–∫–∞–∑–æ–º.
3. –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ 3 —Å—Ç–æ–ª–±—Ü–∞–º 3√ó3 (–≥–¥–µ —É –Ω–µ–≥–æ –±–æ–ª—å—à–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ, –≥–¥–µ –ø—Ä–æ—Ü–µ—Å—Å, –≥–¥–µ –¥–µ–π—Å—Ç–≤–∏–µ).
4. –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–º–µ—â–µ–Ω–∏—è –ø–æ 1/2/3 —Å—Ç–æ–ª–±—Ü—É (–º–∏–Ω—É—Å/–ø–ª—é—Å), —Ç–æ–∂–µ –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.
5. –ì–¥–µ —Å—Ç–æ–∏—Ç ¬´–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä—É–∫–∞–º–∏¬ª –Ω–∞ —Å–µ—Å—Å–∏–∏: –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤–∂–∏–≤—É—é.
6. –û—Å—Ç–æ—Ä–æ–∂–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –ø–æ —Å–≤—è–∑–∫–µ —Ä—è–¥–æ–≤: —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ 1-–º —Ä—è–¥—É (60%), 2-–º (30%), 3-–º (10%), –Ω–æ —Ç–æ–ª—å–∫–æ –∫–∞–∫ –≥–∏–ø–æ—Ç–µ–∑—ã.

–í–∞–∂–Ω–æ: —ç—Ç–æ –æ—Ç—á—ë—Ç **–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞**, –Ω–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. –ü–∏—à–∏ –æ—Ç–∫—Ä—ã—Ç–æ, –Ω–æ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ—Å—Ç–∏.
"""

            try:
                resp = client.chat.completions.create(
                    model="gpt-5.1",
                    messages=[
                        {"role": "system", "content": MASTER_SYSTEM_PROMPT},
                        {"role": "user", "content": user_prompt},
                    ],
                    temperature=0.4,
                )
                report = resp.choices[0].message.content
            except Exception as e:
                report = f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: `{e}`"

        st.markdown("### –ß–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç (–¥–ª—è —Ç–µ–±—è, –ê—Å–µ–ª—è)")
        st.markdown(report)


# ---------- MAIN ----------

def main():
    st.set_page_config(
        page_title="Deep Identity ¬∑ –ö–ª–∏–µ–Ω—Ç / –ú–∞—Å—Ç–µ—Ä",
        layout="wide",
    )

    mode = st.sidebar.radio(
        "–†–µ–∂–∏–º",
        ["–ö–ª–∏–µ–Ω—Ç", "–ú–∞—Å—Ç–µ—Ä"],
    )

    if mode == "–ö–ª–∏–µ–Ω—Ç":
        run_client_flow()
    else:
        run_master_panel()


if __name__ == "__main__":
    main()

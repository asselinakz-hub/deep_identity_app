import os
import json
from datetime import datetime
from typing import List, Dict, Any

import streamlit as st
from openai import OpenAI

# =========================
# –ù–ê–°–¢–†–û–ô–ö–ò
# =========================

RESULTS_FILE = "deep_identity_results.json"

# —Å–ø–∏—Å–æ–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –ø–æ—Ç–æ–º –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ—Ç—á—ë—Ç–µ
POTENTIALS = [
    "–ê–º–µ—Ç–∏—Å—Ç",
    "–ì—Ä–∞–Ω–∞—Ç",
    "–¶–∏—Ç—Ä–∏–Ω",
    "–°–∞–ø—Ñ–∏—Ä",
    "–ì–µ–ª–∏–æ–¥–æ—Ä",
    "–ò–∑—É–º—Ä—É–¥",
    "–Ø–Ω—Ç–∞—Ä—å",
    "–†—É–±–∏–Ω",
    "–®—É–Ω–≥–∏—Ç",
]

MASTER_PASSWORD = "asselya_master"  # –ú–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å


# =========================
# OPENAI CLIENT (—á–µ—Ä–µ–∑ st.secrets –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# =========================

def get_openai_client() -> Client | None:
    api_key = None
    try:
        api_key = st.secrets.get("OPENAI_API_KEY", None)
    except Exception:
        api_key = None

    if not api_key:
        api_key = os.environ.get("OPENAI_API_KEY")

    if not api_key:
        return None

    return OpenAI(api_key=api_key)


# =========================
# –£–¢–ò–õ–ò–¢–´ –†–ê–ë–û–¢–´ –° JSON
# =========================

def load_results() -> List[Dict[str, Any]]:
    if not os.path.exists(RESULTS_FILE):
        return []
    try:
        with open(RESULTS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return []


def save_results(data: List[Dict[str, Any]]) -> None:
    with open(RESULTS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# =========================
# –†–ï–ñ–ò–ú: –ö–õ–ò–ï–ù–¢ (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
# =========================

def run_client_mode():
    st.header("Deep Identity ¬∑ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (—Ä–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞)")

    st.markdown(
        "–≠—Ç–æ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è MVP-–≤–µ—Ä—Å–∏—è. –ß–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç, —Ç—ã —Å–æ–±–∏—Ä–∞–µ—à—å —Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–≤—ã–µ "
        "–Ω–∞–±—Ä–æ—Å–∫–∏ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º, –∞ –ø–æ—Ç–æ–º —É–∂–µ –≤ –º–∞—Å—Ç–µ—Ä-—Ä–µ–∂–∏–º–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –æ—Ç—á—ë—Ç."
    )

    st.markdown("### 1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–µ–ª–æ–≤–µ–∫–µ")

    client_name = st.text_input("–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? (–∏–º—è –∏, –ø–æ –∂–µ–ª–∞–Ω–∏—é, —Ñ–∞–º–∏–ª–∏—è)")
    client_email = st.text_input("Email –∏–ª–∏ Telegram (–ø–æ –∂–µ–ª–∞–Ω–∏—é)")

    st.markdown("### 2. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏")

    q_child = st.text_area(
        "1. –ß–µ–º —Ç—ã –ª—é–±–∏–ª(–∞) –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –≤ –¥–µ—Ç—Å—Ç–≤–µ? –ß—Ç–æ –¥–∞–≤–∞–ª–æ –æ—â—É—â–µ–Ω–∏–µ ¬´—ç—Ç–æ –º–æ—ë¬ª?",
        height=120,
    )
    q_work = st.text_area(
        "2. –ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —Å–µ–π—á–∞—Å (—Ä–∞–±–æ—Ç–∞ / –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å)? –ö–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ —Ä–∞–±–æ—Ç–µ "
        "–¥–∞—é—Ç —Ç–µ–±–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è, –∞ –∫–∞–∫–∏–µ ‚Äî –∑–∞–±–∏—Ä–∞—é—Ç?",
        height=160,
    )
    q_people = st.text_area(
        "3. –ö–∞–∫–∏–µ –ª—é–¥–∏, –≥–µ—Ä–æ–∏, —Ç–∏–ø–∞–∂–∏ —Ç–µ–±—è –≤–æ—Å—Ö–∏—â–∞—é—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤ –Ω–∏—Ö "
        "—Ü–µ–ø–ª—è–µ—Ç?",
        height=160,
    )
    q_free = st.text_area(
        "4. –ï—Å–ª–∏ –±—ã —É —Ç–µ–±—è –±—ã–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –∏ —Å–≤–æ–±–æ–¥—ã, —á–µ–º –±—ã —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è(–∞—Å—å) "
        "–±–µ–∑ –æ—â—É—â–µ–Ω–∏—è ¬´–Ω–∞–¥–æ¬ª, –∞ –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∏ –∫–∞–π—Ñ–∞?",
        height=160,
    )

    st.markdown("### 3. –ß–µ—Ä–Ω–æ–≤–æ–π –Ω–∞–±—Ä–æ—Å–æ–∫ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º (–ø–æ –æ—â—É—â–µ–Ω–∏—è–º –∫–ª–∏–µ–Ω—Ç–∞)")

    st.markdown(
        "–ó–¥–µ—Å—å –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ, —á—Ç–æ —É –Ω–µ–≥–æ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è. –≠—Ç–æ –Ω–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π "
        "—Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –ø—Ä–æ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª –¥–ª—è —Ç–µ–±—è."
    )

    col1, col2 = st.columns(2)
    with col1:
        strong_pots = st.multiselect(
            "–ö–∞–∫–∏–µ —Å–ª–æ–≤–∞ / –∞—Ä—Ö–µ—Ç–∏–ø—ã —Ç–µ–±–µ –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –ø–æ –æ—â—É—â–µ–Ω–∏—è–º?",
            POTENTIALS,
        )
    with col2:
        weak_pots = st.multiselect(
            "–ö–∞–∫–∏–µ –∏–∑ —ç—Ç–∏—Ö –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ –æ—â—É—â–∞—é—Ç—Å—è ¬´—Å–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è¬ª?",
            POTENTIALS,
        )

    st.markdown("### 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)")

    extra_notes = st.text_area(
        "–ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å (–ø—Ä–æ –∑–¥–æ—Ä–æ–≤—å–µ, —Ç–µ–ª–æ, –¥–µ–Ω—å–≥–∏, —ç–º–æ—Ü–∏–∏, —Å–º–µ—â–µ–Ω–∏—è) ‚Äî –Ω–∞–ø–∏—à–∏ –∑–¥–µ—Å—å.",
        height=120,
    )

    st.markdown("---")

    if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞"):
        if not client_name.strip():
            st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –∏–º—è ‚Äî —Ç–∞–∫ —Ç–µ–±–µ –±—É–¥–µ—Ç –ø—Ä–æ—â–µ –ø–æ—Ç–æ–º —Å –æ—Ç—á—ë—Ç–∞–º–∏.")
            return

        all_results = load_results()

        entry = {
            "id": len(all_results) + 1,
            "created_at": datetime.now().isoformat(timespec="seconds"),
            "client_name": client_name.strip(),
            "client_email": client_email.strip(),
            "answers": {
                "child": q_child.strip(),
                "work": q_work.strip(),
                "people": q_people.strip(),
                "free": q_free.strip(),
                "extra": extra_notes.strip(),
            },
            "self_potentials": {
                "strong": strong_pots,
                "weak": weak_pots,
            },
            # –∑–¥–µ—Å—å –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å:
            # "block1_cols": {...},
            # "block2_cols": {...},
            # "block3_cols": {...},
        }

        all_results.append(entry)
        save_results(all_results)

        st.success(
            "–û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã üôå\n\n"
            "–¢–µ–ø–µ—Ä—å —Ç—ã (–∫–∞–∫ –º–∞—Å—Ç–µ—Ä) —Å–º–æ–∂–µ—à—å –∑–∞–π—Ç–∏ –≤ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç."
        )


# =========================
# –†–ï–ñ–ò–ú: –ú–ê–°–¢–ï–† (–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –æ—Ç—á—ë—Ç—ã)
# =========================

def render_client_card(entry: Dict[str, Any]):
    st.markdown(f"### üë§ {entry.get('client_name', '–ë–µ–∑ –∏–º–µ–Ω–∏')}  (ID: {entry.get('id')})")
    st.caption(f"–°–æ–∑–¥–∞–Ω–æ: {entry.get('created_at', '')}")
    email = entry.get("client_email", "")
    if email:
        st.markdown(f"**–ö–æ–Ω—Ç–∞–∫—Ç:** {email}")

    ans = entry.get("answers", {})
    st.markdown("#### –û—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞")
    st.markdown("**1. –î–µ—Ç—Å—Ç–≤–æ / —Ä–∞–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã**")
    st.write(ans.get("child", "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_") or "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_")
    st.markdown("**2. –†–∞–±–æ—Ç–∞ / —Ç–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å**")
    st.write(ans.get("work", "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_") or "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_")
    st.markdown("**3. –õ—é–¥–∏ –∏ –≥–µ—Ä–æ–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ—Å—Ö–∏—â–∞—é—Ç**")
    st.write(ans.get("people", "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_") or "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_")
    st.markdown("**4. –ï—Å–ª–∏ –±—ã –±—ã–ª–∞ –ø–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞‚Ä¶**")
    st.write(ans.get("free", "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_") or "_–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞_")
    extra = ans.get("extra", "")
    if extra:
        st.markdown("**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏**")
        st.write(extra)

    self_p = entry.get("self_potentials", {})
    if self_p.get("strong") or self_p.get("weak"):
        st.markdown("#### –°–∞–º–æ–æ—Ü–µ–Ω–∫–∞ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º")
        if self_p.get("strong"):
            st.markdown(
                "- –°–∏–ª—å–Ω—ã–µ / –±–ª–∏–∑–∫–∏–µ: " + ", ".join(self_p["strong"])
            )
        if self_p.get("weak"):
            st.markdown(
                "- –î–∞–ª—ë–∫–∏–µ / –Ω–µ –º–æ–∏: " + ", ".join(self_p["weak"])
            )


def generate_report_for_entry(entry: Dict[str, Any]) -> str:
    client = get_openai_client()
    if client is None:
        return (
            "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω API-–∫–ª—é—á OpenAI.\n\n"
            "–î–æ–±–∞–≤—å –µ–≥–æ –≤ Streamlit Secrets –∫–∞–∫ `OPENAI_API_KEY` "
            "–∏–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è."
        )

    name = entry.get("client_name", "–ö–ª–∏–µ–Ω—Ç")
    answers = entry.get("answers", {})
    self_p = entry.get("self_potentials", {})

    prompt = f"""
–¢—ã ‚Äî –º–∞—Å—Ç–µ—Ä –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (–ê–º–µ—Ç–∏—Å—Ç, –ì—Ä–∞–Ω–∞—Ç, –¶–∏—Ç—Ä–∏–Ω, –°–∞–ø—Ñ–∏—Ä, –ì–µ–ª–∏–æ–¥–æ—Ä,
–ò–∑—É–º—Ä—É–¥, –Ø–Ω—Ç–∞—Ä—å, –†—É–±–∏–Ω, –®—É–Ω–≥–∏—Ç). –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –º—è–≥–∫–∏–π, —Ç–æ—á–Ω—ã–π –∏
—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **—á–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç** –¥–ª—è –ê—Å–µ–ª–∏ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞.

–ö–ª–∏–µ–Ω—Ç: {name}

–û—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞:

1) –î–µ—Ç—Å—Ç–≤–æ, —Ä–∞–Ω–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
\"\"\"{answers.get("child", "")}\"\"\"

2) –†–∞–±–æ—Ç–∞, —Ç–µ–∫—É—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
\"\"\"{answers.get("work", "")}\"\"\"

3) –õ—é–¥–∏, –≥–µ—Ä–æ–∏, —Ç–∏–ø–∞–∂–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ—Å—Ö–∏—â–∞—é—Ç:
\"\"\"{answers.get("people", "")}\"\"\"

4) –ï—Å–ª–∏ –±—ã –±—ã–ª–∞ –ø–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞ (–¥–µ–Ω—å–≥–∏, –≤—Ä–µ–º—è):
\"\"\"{answers.get("free", "")}\"\"\"

5) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏:
\"\"\"{answers.get("extra", "")}\"\"\"

–°–∞–º–æ–æ—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º:
- –±–ª–∏–∂–µ –≤—Å–µ–≥–æ: {", ".join(self_p.get("strong", [])) or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –¥–∞–ª—å—à–µ –≤—Å–µ–≥–æ: {", ".join(self_p.get("weak", [])) or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}

–°–¥–µ–ª–∞–π –æ—Ç—á—ë—Ç **–¥–ª—è –ê—Å–µ–ª–∏**, –Ω–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. –¢–æ –µ—Å—Ç—å —ç—Ç–æ —Ä–∞–±–æ—á–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫,
–∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–ª–∏ —Å–º—è–≥—á–∏—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á—ë—Ç–∞:

1. –ö—Ä–∞—Ç–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî –∫–∞–∫ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
2. –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–º–∏–Ω–∞–Ω—Ç—ã –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ 3‚Äì5 –∫–ª—é—á–µ–≤—ã–º –∞—Ä—Ö–µ—Ç–∏–ø–∞–º)
   ‚Äî —Å –∫–æ—Ä–æ—Ç–∫–∏–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º, –Ω–∞ —á—Ç–æ —Ç—ã –æ–ø–∏—Ä–∞–µ—à—å—Å—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö.
3. –†–∏—Å–∫–∏ –∏ —Å–º–µ—â–µ–Ω–∏—è:
   - –≥–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å -1 / -2 / -3 —Å–º–µ—â–µ–Ω–∏–µ,
   - –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –∂–∏–∑–Ω–∏ (–ø–æ –æ—Ç–≤–µ—Ç–∞–º),
   - –Ω–∞ —á—Ç–æ –ê—Å–µ–ª–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –≤ —Å–µ—Å—Å–∏–∏.
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç–µ:
   - 3‚Äì5 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –≥–¥–µ —á–µ–ª–æ–≤–µ–∫—É –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–≥–ª—É–±–ª–µ–Ω–∏–µ / –ø—Ä–æ–¥—É–∫—Ç—ã,
   - —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã (—Ä–∞–∑–±–æ—Ä, –º–∞—Ä–∞—Ñ–æ–Ω, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ, –∫—É—Ä—Å).
5. –ò–¥–µ–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (2‚Äì3 —Ñ—Ä–∞–∑—ã), –∫–∞–∫ –º–æ–∂–Ω–æ –º—è–≥–∫–æ –æ—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç—å –µ–º—É –µ–≥–æ
   –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã –∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.

–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∂–∏–≤—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º. –ù–µ –±—É–¥—å —Å–ª–∏—à–∫–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã–º,
–æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Å—Å–∏–∏.
"""

    try:
        resp = client.chat.completions.create(
            model="gpt-5.1",
            messages=[
                {
                    "role": "system",
                    "content": (
                        "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ê—Å–µ–ª–∏, —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º. "
                        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –µ–π –¥—É–º–∞—Ç—å, –∞ –Ω–µ –∑–∞–º–µ–Ω—è—Ç—å –µ—ë."
                    ),
                },
                {"role": "user", "content": prompt},
            ],
            temperature=0.7,
        )
        return resp.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: `{e}`"


def run_master_mode():
    st.header("Deep Identity ¬∑ –ú–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å –ê—Å–µ–ª–∏")

    st.markdown(
        "–ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ **—Ç—ã** –≤–∏–¥–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –∏—Ö –æ—Ç–≤–µ—Ç—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—à—å –æ—Ç—á—ë—Ç—ã. "
        "–ö–ª–∏–µ–Ω—Ç—ã —Å—é–¥–∞ –Ω–µ –∑–∞—Ö–æ–¥—è—Ç."
    )

    pwd = st.sidebar.text_input("–ü–∞—Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞", type="password")
    if pwd != MASTER_PASSWORD:
        st.warning("–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ.")
        return

    results = load_results()
    if not results:
        st.info(
            "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ `deep_identity_results.json`.\n\n"
            "–ü–æ–ø—Ä–æ—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–æ–π—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤ —Ä–µ–∂–∏–º–µ '–ö–ª–∏–µ–Ω—Ç' –∏ –Ω–∞–∂–∞—Ç—å "
            "–∫–Ω–æ–ø–∫—É '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç'."
        )
        return

    st.markdown("### –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤")

    # –Ω–µ–±–æ–ª—å—à–æ–π summary-—Ç–∞–±
    table_rows = []
    for r in results:
        table_rows.append(
            {
                "ID": r.get("id"),
                "–ò–º—è": r.get("client_name", ""),
                "–î–∞—Ç–∞": r.get("created_at", "")[:10],
                "Email / TG": r.get("client_email", ""),
            }
        )

    st.dataframe(table_rows, hide_index=True, use_container_width=True)

    st.markdown("---")
    st.markdown("### –í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –æ—Ç—á—ë—Ç–∞")

    ids = [r.get("id") for r in results]
    id_to_entry = {r.get("id"): r for r in results}

    selected_id = st.selectbox("–í—ã–±–µ—Ä–∏ ID –∫–ª–∏–µ–Ω—Ç–∞", ids)
    entry = id_to_entry.get(selected_id)

    if entry:
        render_client_card(entry)

        st.markdown("---")
        st.markdown("### üß† –ß–µ—Ä–Ω–æ–≤–æ–π –æ—Ç—á—ë—Ç –æ—Ç –ò–ò (–¥–ª—è —Ç–µ–±—è)")

        if st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –ø–æ —ç—Ç–æ–º—É –∫–ª–∏–µ–Ω—Ç—É"):
            with st.spinner("–î—É–º–∞—é –Ω–∞–¥ –æ—Ç—á—ë—Ç–æ–º‚Ä¶"):
                report_txt = generate_report_for_entry(entry)
            st.markdown(report_txt)

            # –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç –≤–Ω—É—Ç—Ä—å –∑–∞–ø–∏—Å–∏
            entry["last_report"] = {
                "generated_at": datetime.now().isoformat(timespec="seconds"),
                "text": report_txt,
            }
            save_results(results)

        if entry.get("last_report"):
            with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –æ—Ç—á—ë—Ç"):
                st.markdown(entry["last_report"]["text"])


# =========================
# MAIN
# =========================

def main():
    st.set_page_config(
        page_title="Deep Identity ¬∑ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –º–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å",
        page_icon="üß¨",
        layout="wide",
    )

    mode = st.sidebar.radio("–†–µ–∂–∏–º", ["–ö–ª–∏–µ–Ω—Ç", "–ú–∞—Å—Ç–µ—Ä"])

    if mode == "–ö–ª–∏–µ–Ω—Ç":
        run_client_mode()
    else:
        run_master_mode()


if __name__ == "__main__":
    main()
